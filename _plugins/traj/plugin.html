<plugin>
    <div class="mobile-header" style="font-weight:bold">Trajectory Plugin</div>
    <div  class="plugin-content">
        <span id="desktop-title" style="font-size:15px; font-weight:bold;">Trajectory Plugin</span>  <br>  <br>
        &nbsp;-&nbsp;Place the picker. <br>
        &nbsp;-&nbsp;Select levels. <br>
        &nbsp;-&nbsp;Select trajectory duration. <br>
        &nbsp;-&nbsp;Set start time with Windy slider.   <br>
        &nbsp;-&nbsp;Start!    <br>
        &nbsp;-&nbsp;Current sample interval is 15 minutes.  <br>
        &nbsp;-&nbsp;Duration slider will show progress. <br>
        &nbsp;-&nbsp;You can create many trajectories.   <br>
        &nbsp;-&nbsp;Clicking a trajectory will switch the map to the correct timestamp and level. <br>
        &nbsp;-&nbsp;ECMWF data with pluginDataLoader is used.<br>  <br>
        <div id="select-colors" style="display:inline-block">
            <span style="font-size:15px; font-weight:bold;">Select Colors:</span><br> <br>
        </div>
        <div id="colpick" style="position:relative;display:inline-block; vertical-align:top;"></div>
    </div>

	<script>
	import map from '@windy/map';
	import store from '@windy/store';
	import bcast from '@windy/broadcast';
    import picker from '@windy/picker';
    import $ from '@windy/$';
    import rs from '@windy/rootScope';
    import utils from '@windy/utils';
    import ib from './infobox.mjs';
    import pluginDataLoader from '@windy/pluginDataLoader'

    const load = pluginDataLoader({
		key: 'tqBdvHJjtNrGq4TrFzt9D5NDz9fIZSC8'
		, plugin: 'windy-plugin-da'
	});

    let pickerPos;
    let durmin=0;
    let reftime;
    let hrsInt;
    let h1=60*60*1000;  let h3=3*h1;  let min1=60*1000;   let d6=6*24*60*60*1000;
    let sample=15;
    let ts;
    let datai;
    let selpth;

    let levels=store.get("availLevels");
    let selLvls=[ {lvl: "surface", alt:"30", sel: false, col:"rgba(205, 92, 92, 1)"}
        , {lvl: "100m", alt:"330",   sel: false,  col: "rgba(255, 160, 122, 1) "}
        , {lvl: "950h", alt:"2000",  sel: false,  col: "rgba(255, 0, 0, 1)"}
        , {lvl: "925h", alt:"2500",  sel: false,  col: "rgba(255, 192, 203, 1)   "}
        , {lvl: "900h", alt:"3000",  sel: false,  col: "rgba(255, 105, 180, 1) "}
        , {lvl: "850h", alt:"5000",  sel: false,  col: "rgba(255, 160, 122, 1)"}
        , {lvl: "800h", alt:"6400",  sel: false,  col: "rgba(255, 165, 0, 1)"}
        , {lvl: "700h", alt:"10000", sel: false,  col: "rgba(255, 255, 0, 1)"}
        , {lvl: "600h", alt:"14000", sel: false,  col: "rgba(255, 228, 181, 1)"}
        , {lvl: "500h", alt:"18000", sel: false,  col: "rgba(255, 0, 255, 1)"}
        , {lvl: "400h", alt:"24000", sel: false,  col: "rgba(173, 255, 47, 1)"}
        , {lvl: "300h", alt:"30000", sel: false,  col: "rgba(0, 255, 255, 1)"}
        , {lvl: "200h", alt:"39000", sel: false,  col: "rgba(135, 206, 250, 1)" }
        , {lvl: "150h", alt:"45000", sel: false,  col: "rgba(255, 255, 255, 1)"}];

    ////Box at bottom left
    ib(`<div style="padding:5px 5px 3px 5px ; display:inline-block; pointer-events:auto; border-radius:7px; background-color:rgba(0,0,0,0.5); border:  1px solid rgba(0,0,0,0.6)">
            <div id="select-levels" style="width:230px; font-size:12px; margin-bottom:8px;"><div style="margin-bottom:5px;font-size:13px">Select Levels</div></div>
            <div style="position:relative; width:230px; height:20px;  border-radius:8px; border:1px solid rgba(255,255,255,0.5);">
                <input id="dur_range" style="left:3px; height:20px; top:-1px; position:absolute;  width:212px; z-index:999; opacity:0;" type="range"  max="96" >
                <div id="thumb1" class="thumb"></div>
                <div id="progress-thumb" class="thumb" style="opacity:0" ></div>
            </div>
            <div  style="display:inline-block;  width:100px;  padding-top:6px; ">Duration: <span id="duration"></span></div>
            <div id="start-IP" class="start-buttons">
                Start
            </div>
            <div id="clear-IP" class="start-buttons" style="margin-left:2px;margin-right:2px;">
                Clear
            </div>
            <div id="open-left-pane" class="start-buttons">
                Menu
            </div>
        </div>
        `,
        "open-left-pane", "windy-plugin-traj", this
    );
    $("#start-IP").addEventListener("click",()=>{
        ts=store.get("timestamp");
        datai=Math.floor((ts-reftime-h3/2)/h3);
        if (picker.getParams)  drawTraj(picker.getParams());  else console.log("Place the picker,  then click start");
    });
    $("#clear-IP").addEventListener("click",()=>{
        traj.forEach(e=>e.forEach(l=>{
            l.line.remove();
            l.ghostline.remove();
            l.mrkr.forEach(m=>m.remove());
        }));
        traj=[];
    });
    $("#dur_range").addEventListener("input",e=>{
        $('#thumb1').style.left=210*e.target.value/96+'px';
        durmin=e.target.value*15;
        $('#duration').innerHTML=('0'+Math.floor(durmin/60)).slice(-2)+':'+('0'+ durmin%60).slice(-2);
    });

    if (rs.isMobile)$("#desktop-title").style.display="none";
    if (rs.isTablet){$("#logo").style.left="100%"; $("#logo").style.marginLeft="-150px";}

    selLvls.forEach((e,i)=>{
        e.div=document.createElement("div");
        e.div.innerHTML=e.lvl+" "+(e.alt<10000?(e.alt+"ft"):(e.alt/100+"FL"));
        e.div.style.display="inline-block"; e.div.style.opacity=0.5;  e.div.style.width="105px";
        e.div.addEventListener("click",el=>{
            if(e.sel){
                e.div.style.opacity=0.5;
                e.sel=false;
                e.div.style.color="white";
            } else {
                e.div.style.opacity=1;
                e.div.style.color=e.col;
                e.sel=true;
            }
        });

        let lbl=document.createElement("div");  lbl.innerHTML="<span style='display:inline-block;width:50px'>"+e.lvl+"</span>";
        $("#select-colors").appendChild(lbl);
        e.input=document.createElement("input");
        e.input.type="text";
        e.input.value=e.col;
        e.input.dataset.i=i;
        e.input.classList.add("trajColor");
        lbl.appendChild(e.input);
        e.input.onfocus=()=>{
            setTimeout(()=>{
                $("#colpick").firstElementChild.style.transition="all 0.3s";
                $("#colpick").firstElementChild.style.left="3px";
                $("#colpick").firstElementChild.style.top="25px";
            },100);
        }
        e.input.onkeydown=e=>e.stopPropagation();
        e.input.onchange=e=>{e.target.blur();e.target.focus()}
        $("#select-levels").appendChild(e.div);
    })

    ////color picker
    function cb(col,b,c){
        let i=c.input.dataset.i;
        selLvls[i].col=c.input.value;
        if(selLvls[i].sel) selLvls[i].div.style.color=selLvls[i].col;
        c.input.style.color=col.alpha<0.4?"black":(col.RGBLuminance<0.3?"white":"black");
    }

    setTimeout(()=>{
        window.jsColorPicker("input.trajColor",{
            customBG:"#222",
            readOnly:false,
            size:1,
            appendTo: $("#colpick"),
            init:function(o,e){
                o.style.backgroundColor=o.value,
                o.style.color=e.alpha<0.4?"black":(e.RGBLuminance<0.3?"white":"black");
            },
            displayCallback:cb
        });
    },500);

    ////grab reftime
    let cntr=map.getCenter();   cntr.lon=cntr.lng;  cntr.model="ecmwf";
    load("forecast",cntr).then(data=>{
        reftime=new Date(data.data.header.refTime).getTime();
    });

    function time2path(t){
        hrsInt=t-reftime>d6?6:3;
        let tmshift=new Date(t+hrsInt*30*60*1000);
        return tmshift.getUTCFullYear()+"/"+("0"+(tmshift.getUTCMonth()+1)).slice(-2)+"/"+("0"+tmshift.getUTCDate()).slice(-2)+"/"+("0"+Math.floor(tmshift.getUTCHours()/hrsInt)*hrsInt).slice(-2);
    }

    function time2index(t){
        return Math.floor((t-reftime-h3/2)/h3);
    }

    let traj=[];

    ////highlight time segment
    store.on("timestamp",e=>{
        let p=store.get("path");
        if (selpth!=p){
            traj.forEach(e=>e.forEach(l=>{
                if (l.pth==p)l.line.setStyle({weight:4});
                else l.line.setStyle({weight:2});
            }));
            selpth=p;
        }
    });

    store.on("level",lvl=>{
        selLvls.forEach(e=>{
            e.div.style.fontWeight= e.lvl==lvl?"bold":"normal";
        })
        if(lvl=="100m")lvl="1000h";
        traj.forEach(e=>e.forEach(l=>{
            if (l.lvl==lvl)l.line.setStyle({opacity:1});
            else l.line.setStyle({opacity:0.4});
        }));
    });

    function drawTraj(cstart,startt=false,lv=-1){
        let c=cstart;
        if (!startt)startt= Math.floor((store.get("timestamp")+sample*min1)/(sample*min1))*sample*min1;
        $('#progress-thumb').style.opacity=0.4;

        let nextLvl=(lv)=>{
            for (lv++ ;lv<selLvls.length&&!selLvls[lv].sel ;lv++);
            return lv<selLvls.length?lv:-1;
        }

        if (lv<0){
            lv=nextLvl(lv);
            if (lv<0) return;
        }
        let lvl=selLvls[lv].lvl;
        let col=selLvls[lv].col;

        if (lvl=="100m")     lvl="1000h";
        else if (lvl=="250h"){lvl="300h"; store.set("level",lvl)}

        traj.forEach(e=>e.forEach(l=>l.line.setStyle({opacity:0.4})));
        let k=traj.push([])-1;
        let previ=-99;
        let j=-1;
        let n=0;

        let fetchData=(c,t,lvl)=>{
            c.model="ecmwf";
            let i=time2index(t);
            n+=sample/15;
            $('#progress-thumb').style.left=180*n/96+'px';
            selpth=time2path(t);
            store.set("timestamp",t);
            if (i!=previ){
                j++;
                //console.log(col);
                traj[k][j]={
                    line:L.polyline([c], {color: col, weight:2, opacity:1, interactive:false, smoothFactor:0.1}).addTo(map),
                    ghostline:L.polyline([c], {color: "white", opacity:0, weight:13, smoothFactor:0.1, interactive:true, bubblingMouseEvents:false}).addTo(map),
                    lvl:lvl, t:t, pth:selpth, j:j, k:k,  mrkr:[]
                };
                let ll=traj[k][j];
                ll.ghostline.on("click",ev=>{

                    let evlt=ev.latlng.lat, evln=ev.latlng.lng; let mind=Infinity; let ii;
                    ll.line._latlngs.forEach((m,i)=>{
                        let d=(m.lat-evlt)*(m.lat-evlt)+(m.lng-evln)*(m.lng-evln);
                        if (d<mind){mind=d; ii=i}
                    })
                    store.set("timestamp",ll.t+ii*sample*min1);

                    selpth=ll.pth;
                    store.set("level",ll.lvl=="1000h"?"100m":ll.lvl);
                    selLvls.forEach(e=>{
                        if(ll.lvl==e.lvl)e.div.style.fontWeight="bold"; else e.div.style.fontWeight="normal";
                    })
                    traj.forEach(e=>e.forEach(l=>{
                        if (ll.k==l.k){
                            if (ll.j==l.j) l.line.setStyle({weight:4, opacity:1});
                            else l.line.setStyle({weight:2, opacity:0.9});
                        }else l.line.setStyle({weight:2,opacity:0.4});
                    }));
                });
                previ=i;
            }

            let fetchPoint=c=>{
                load('airData',c).then(data=>{
                    let v=data.data.data["wind_v-"+lvl][i];
                    let u=data.data.data["wind_u-"+lvl][i];
                    let o=utils.wind2obj([u,v,0]);
                    let d=sample*60*o.wind;
                    var dirto=(o.dir+180)%360;

                     /////////calculate next point,  thx to Chris Veness (github)
                    var ad=d/6371000;//angular distance
                    var rad=Math.PI/180;
                    var brng=dirto*rad;
                    var lat1=c.lat*rad;
                    var lon1=c.lon*rad;
                    var lat2 = Math.asin(Math.sin(lat1)*Math.cos(ad) + Math.cos(lat1)*Math.sin(ad)*Math.cos(brng))   ;
                    var lon2 = lon1 + Math.atan2(Math.sin(brng)*Math.sin(ad)*Math.cos(lat1), Math.cos(ad)-Math.sin(lat1)*Math.sin(lat2))   ;
                    lat2/=rad; lon2/=rad;
                    ///////////

                    traj[k][j].line.addLatLng([lat2,lon2]);
                    traj[k][j].ghostline.addLatLng([lat2,lon2]);

                    if (t%h1==0){
                        let tm=t;
                        traj[k][j].mrkr.push(
                             L.circleMarker(c,{radius:2,color:"black", weight:1,  opacity:0.5, interactive:false})
                                .addTo(map)
                        );
                    }

                    t+=sample*min1;
                    if ((t<reftime+d6)&&(t<ts+durmin*min1)){
                        setTimeout(fetchData,300,{lat:lat2,lon:lon2},t,lvl);
                    }   else {
                        if (t>reftime+d6)  console.error("Only 6 days available in dataloader.  Ivo and team:  Please add more");
                        store.set("timestamp",startt);
                        $('#progress-thumb').style.opacity=0;
                        lv=nextLvl(lv);
                        if (lv>=0){
                            drawTraj(cstart,startt,lv);
                        }
                    }
                }).catch(er=>{
                    console.log("usually  blocked by server CORS error - too busy???",   er);  /////usually  blocked by server CORS error - too busy???
                    setTimeout(fetchPoint,1000,c);
                });
            }
            fetchPoint(c);
        }
        if(lvl){
            store.set("level",lvl=="1000h"?"100m":lvl);
            fetchData(c,startt,lvl);
        }
    }

	</script>
</plugin>
